version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: api_gateway
    ports: ["80:80"]
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      auth_service:
        condition: service_healthy
      chat_service:
        condition: service_healthy
      ecg_analysis_service:
        condition: service_healthy
      frontend:
        condition: service_healthy
    restart: unless-stopped
    networks: [app_network]

  auth_service:
    build: ./auth_service
    container_name: auth_service
    ports: ["8000:8000"]
    environment:
      - SECRET_KEY=${SECRET_KEY:-dev-secret}
      # ВАЖНО: либо создавай auth_user/auth_db в init.sql, либо выровняй URL под user/password/postgres:
      - DATABASE_URL=${AUTH_DATABASE_URL:-postgresql://user:password@postgres:5432/postgres}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      # проверяем, что порт 8000 слушает (без curl)
      test: ["CMD-SHELL", "python -c \"import socket,sys; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1',8000)); s.close(); print('ok')\""]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    restart: unless-stopped
    networks: [app_network]

  chat_service:
    build: ./chat_service
    container_name: chat_service
    ports: ["8080:8080"]
    environment:
      - DATABASE_URL=${CHAT_DATABASE_URL:-postgresql://user:password@postgres:5432/postgres}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - ECG_BUCKET=${ECG_BUCKET:-ecg-bucket}
      - RABBIT_URL=${RABBIT_URL:-amqp://guest:guest@rabbitmq:5672/%2F}
      - REQUEST_QUEUE=${REQUEST_QUEUE:-ecg_requests}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1',8080)); s.close(); print('ok')\""]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 40s
    restart: unless-stopped
    networks: [app_network]

  ecg_analysis_service:
    build: ./ecg_analysis_service
    container_name: ecg_analysis_service
    ports: [ "8081:8080" ]
    environment:
      - RABBIT_URL=${RABBIT_URL:-amqp://guest:guest@rabbitmq:5672/%2F}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - REQUEST_QUEUE=${REQUEST_QUEUE:-ecg_requests}
      - RESPONSE_QUEUE=${RESPONSE_QUEUE:-ecg_responses}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      # пингуем RabbitMQ и MinIO (оба обязательны для работы)
      test: [ "CMD-SHELL", "python - <<'PY'\nimport pika,os,sys;import socket\n# RabbitMQ\nparams=pika.URLParameters(os.getenv('RABBIT_URL','amqp://guest:guest@rabbitmq:5672/%2F'))\nconn=pika.BlockingConnection(params); conn.close()\n# MinIO TCP\nh=os.getenv('MINIO_ENDPOINT','minio:9000').split(':')[0]; p=int(os.getenv('MINIO_ENDPOINT','minio:9000').split(':')[1]); s=socket.socket(); s.settimeout(2); s.connect((h,p)); s.close(); print('ok')\nPY" ]
      interval: 15s
      timeout: 7s
      retries: 10
      start_period: 40s
    restart: unless-stopped
    networks: [ app_network ]

  frontend:
    build: ./frontend
    container_name: frontend
    ports: ["8001:8000"]
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1',8000)); s.close(); print('ok')\""]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    networks: [app_network]

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./nginx/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-user} -d ${POSTGRES_DB:-postgres} -h 127.0.0.1 -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    restart: unless-stopped
    networks: [app_network]

  minio:
    image: minio/minio:latest
    container_name: minio
    ports: ["9000:9000","9001:9001"]
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD-SHELL", "mc --version >/dev/null 2>&1 || (wget -qO /bin/mc https://dl.min.io/client/mc/release/linux-amd64/mc && chmod +x /bin/mc); mc alias set local http://127.0.0.1:9000 ${MINIO_ACCESS_KEY:-minioadmin} ${MINIO_SECRET_KEY:-minioadmin} >/dev/null 2>&1 && mc ready local"]
      interval: 15s
      timeout: 7s
      retries: 20
      start_period: 20s
    restart: unless-stopped
    networks: [app_network]

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    ports: ["5672:5672","15672:15672"]
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS:-guest}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s
    restart: unless-stopped
    networks: [app_network]

volumes:
  postgres_data:
  minio_data:
  rabbitmq_data:

networks:
  app_network:
    driver: bridge
